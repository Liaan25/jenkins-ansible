---
# ==============================================================================
# Главный Playbook для развертывания системы мониторинга
# ==============================================================================
# 
# Описание:
#   Полное развертывание безопасной системы мониторинга (Prometheus + Grafana + Harvest)
#   с соблюдением всех корпоративных требований безопасности
#
# Использование:
#   ansible-playbook -i inventories/production playbooks/deploy_monitoring.yml
#
# Дополнительные параметры:
#   --extra-vars "netapp_api_addr=netapp-cluster.example.com"
#   --extra-vars "rlm_token=YOUR_RLM_TOKEN"
#   --tags "setup,config"  # Выполнить только определенные теги
#   --check                # Dry-run режим
#   --diff                 # Показать изменения
#
# ==============================================================================

- name: "Предварительные проверки"
  hosts: all
  gather_facts: yes
  become: no
  tags: [always]
  
  tasks:
    - name: "Проверка подключения к серверам"
      ping:
    
    # SECURITY: Проверка ansible_user удалена - безопасность обеспечивается через:
    # 1. SSH ключ аутентификация (контролируется Jenkins credentials)
    # 2. sudo права (контролируются через sudoers с явными путями)
    # 3. Все задачи используют become с конкретными пользователями
    
    - name: "Вывод информации о развертывании"
      debug:
        msg:
          - "=========================================="
          - "РАЗВЕРТЫВАНИЕ СИСТЕМЫ МОНИТОРИНГА"
          - "=========================================="
          - "Целевой сервер: {{ inventory_hostname }}"
          - "IP адрес: {{ ansible_default_ipv4.address | default('N/A') }}"
          - "Пользователь: {{ ansible_user }}"
          - "Базовая директория: {{ monitoring_base_dir }}"
          - "=========================================="

# ==============================================================================
# ЭТАП 1: Подготовка сервера
# ==============================================================================

- name: "ЭТАП 1: Подготовка инфраструктуры"
  hosts: all
  gather_facts: yes
  become: yes
  become_user: root
  tags: [setup, prepare]
  
  roles:
    - role: common
      tags: [common]

# ==============================================================================
# ЭТАП 1.5: Установка Vault Agent через RLM
# ==============================================================================

- name: "ЭТАП 1.5: Установка Vault Agent через RLM"
  hosts: all
  gather_facts: yes
  become: no
  connection: local
  tags: [install, rlm, vault]
  
  tasks:
    - name: "RLM | Получение IP адреса сервера (если передан FQDN)"
      set_fact:
        server_ip_address: "{{ ansible_default_ipv4.address }}"
      tags: [vault]
    
    - name: "RLM | Информация о сервере для RLM Vault Agent"
      debug:
        msg: |
          RLM Vault Agent параметры:
            - IP: {{ server_ip_address }}
            - SEC_MAN_ADDR: {{ sec_man_addr | upper }}
            - Namespace: {{ vault_namespace }}
            - Vault Agent User: {{ vault_agent_user }}
            - Vault Agent Group: {{ vault_agent_group }}
            - Skip: {{ skip_rlm_vault_agent | default(false) }}
      tags: [vault]
    
    - name: "RLM | ПРОПУСК установки Vault Agent (параметр SKIP_RLM_VAULT_AGENT=true)"
      debug:
        msg: "⚠️  Vault Agent НЕ будет установлен через RLM. Убедитесь что он уже установлен вручную!"
      when: skip_rlm_vault_agent | default(false) | bool
      tags: [vault]
    
    - name: "RLM | Установка Vault Agent через RLM сценарий"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            v_url: "{{ sec_man_addr | upper }}"
            tenant: "{{ vault_namespace }}"
            serv_user: "{{ vault_agent_user }}"
            serv_group: "{{ vault_agent_group }}"
            read_user: "{{ vault_agent_user }}"
            approle: "approle/vault-agent"
            start_after_configuration: false
            log_num: 5
            log_size: 5
            log_level: "info"
            config_unwrapped: true
            skip_sm_conflicts: false
            templates:
              - source:
                  file_name: null
                  content: null
                destination:
                  path: null
          start_at: "now"
          service: "vault_agent_config"
          items:
            - table_id: "secmanserver"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: vault_install_task
      when: not (skip_rlm_vault_agent | default(false) | bool)
      tags: [vault]
    
    - name: "RLM | Мониторинг установки Vault Agent (ожидание завершения)"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ vault_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: vault_status
      until: vault_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: vault_status.json.status in ['failed', 'error']
      when: not (skip_rlm_vault_agent | default(false) | bool)
      tags: [vault]

# ==============================================================================
# ЭТАП 2: Настройка Vault Agent и генерация secrets_vault_agent.json
# ==============================================================================

- name: "ЭТАП 2: Настройка Vault Agent и получение секретов"
  hosts: all
  gather_facts: yes
  become: yes
  become_user: root
  tags: [vault, secrets]
  
  tasks:
    - name: "Vault | Получение UID пользователя monitoring_service_user (через getent)"
      getent:
        database: passwd
        key: "{{ monitoring_service_user }}"
      register: monitoring_user_info
      tags: [setup, systemd]
    
    - name: "Vault | Установка переменной monitoring_service_user_uid"
      set_fact:
        monitoring_service_user_uid: "{{ getent_passwd[monitoring_service_user][1] }}"
      tags: [setup, systemd]
    
    # =========================================================================
    # НАСТРОЙКА VAULT AGENT (создание agent.hcl с templates)
    # =========================================================================
    
    - name: "Vault | Добавление {{ monitoring_service_user }} в группу {{ vault_agent_group }} для доступа к секретам"
      user:
        name: "{{ monitoring_service_user }}"
        groups: "{{ vault_agent_group }}"
        append: yes
      tags: [permissions]
    
    - name: "Vault | Создание директорий для Vault Agent"
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ vault_agent_user }}"
        group: "{{ vault_agent_group }}"
        mode: "0750"
      loop:
        - "/opt/vault/conf"
        - "/opt/vault/log"
        - "/opt/vault/certs"
      become: yes
      become_user: root
      tags: [setup]
    
    - name: "Vault | Копирование role_id.txt и secret_id.txt из /dev/shm/ в /opt/vault/conf/"
      copy:
        src: "/dev/shm/monitoring_secrets/{{ item }}"
        dest: "/opt/vault/conf/{{ item }}"
        owner: "{{ vault_agent_user }}"
        group: "{{ vault_agent_group }}"
        mode: "0640"
        remote_src: yes
      loop:
        - role_id.txt
        - secret_id.txt
      become: yes
      become_user: root
      tags: [setup, vault]
    
    - name: "Vault | Проверка скопированных файлов в /opt/vault/conf/"
      stat:
        path: "/opt/vault/conf/{{ item }}"
      loop:
        - role_id.txt
        - secret_id.txt
      register: vault_conf_files_check
      tags: [check, vault]
    
    - name: "Vault | Информация о скопированных файлах"
      debug:
        msg: "{{ item.item }}: {{ 'EXISTS' if item.stat.exists else 'MISSING' }} ({{ item.stat.size | default(0) }} bytes)"
      loop: "{{ vault_conf_files_check.results }}"
      tags: [check, vault]
    
    - name: "Vault | Создание agent.hcl с templates (как в deploy_monitoring.sh)"
      template:
        src: "../roles/vault_agent/templates/agent.hcl.j2"
        dest: "/opt/vault/conf/agent.hcl"
        owner: "{{ vault_agent_user }}"
        group: "{{ vault_agent_group }}"
        mode: "0640"
      tags: [config]
    
    - name: "Vault | Перезапуск Vault Agent для применения новой конфигурации"
      systemd:
        name: vault-agent
        state: restarted
      tags: [service]
    
    # =========================================================================
    # ОЖИДАНИЕ СОЗДАНИЯ СЕКРЕТОВ И СЕРТИФИКАТОВ
    # =========================================================================
    
    - name: "Vault | Ожидание создания secrets_vault_agent.json от Vault Agent"
      wait_for:
        path: "/dev/shm/monitoring_secrets/secrets_vault_agent.json"
        timeout: 300
      tags: [wait]
    
    - name: "Vault | Ожидание получения TLS сертификатов от Vault Agent"
      wait_for:
        path: "/opt/vault/certs/server_bundle.pem"
        timeout: 300
      tags: [wait]
    
    # =========================================================================
    # ПРОВЕРКА СОЗДАННЫХ ФАЙЛОВ
    # =========================================================================
    
    - name: "Vault | Проверка созданных файлов"
      stat:
        path: "{{ item }}"
      loop:
        - "/dev/shm/monitoring_secrets/secrets_vault_agent.json"
        - "/opt/vault/certs/server_bundle.pem"
        - "/opt/vault/certs/ca_chain.crt"
      register: vault_files_check
      tags: [check]
    
    - name: "Vault | Информация о созданных файлах Vault Agent"
      debug:
        msg: "{{ item.item }}: {{ 'EXISTS' if item.stat.exists else 'MISSING' }} ({{ item.stat.size | default(0) }} bytes)"
      loop: "{{ vault_files_check.results }}"
      tags: [check]
    
    # =========================================================================
    # КОПИРОВАНИЕ СЕРТИФИКАТОВ для monitoring stack (как в deploy_monitoring.sh)
    # =========================================================================
    
    - name: "Vault | Создание директории /opt/monitoring/certs/"
      file:
        path: "/opt/monitoring/certs"
        state: directory
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0750"
      tags: [certs]
    
    - name: "Vault | Копирование TLS сертификатов из /opt/vault/certs/ → /opt/monitoring/certs/"
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0640"
        remote_src: yes
      loop:
        - { src: "/opt/vault/certs/server_bundle.pem", dest: "/opt/monitoring/certs/server_bundle.pem" }
        - { src: "/opt/vault/certs/ca_chain.crt", dest: "/opt/monitoring/certs/ca_chain.crt" }
      tags: [certs]
    
    - name: "Vault | Проверка скопированных сертификатов"
      stat:
        path: "{{ item }}"
      loop:
        - "/opt/monitoring/certs/server_bundle.pem"
        - "/opt/monitoring/certs/ca_chain.crt"
      register: monitoring_certs_check
      tags: [check, certs]
    
    - name: "Vault | Информация о сертификатах в /opt/monitoring/certs/"
      debug:
        msg: "{{ item.item }}: {{ 'EXISTS' if item.stat.exists else 'MISSING' }} (owner: {{ item.stat.pw_name | default('unknown') }}:{{ item.stat.gr_name | default('unknown') }})"
      loop: "{{ monitoring_certs_check.results }}"
      tags: [check, certs]

# ==============================================================================
# ЭТАП 2.5: Установка RPM пакетов через RLM (использует secrets_vault_agent.json)
# ==============================================================================

- name: "ЭТАП 2.5: Установка RPM пакетов через RLM"
  hosts: all
  gather_facts: no
  become: no
  connection: local
  tags: [install, rlm, rpm]
  
  tasks:
    - name: "RLM | Получение IP адреса сервера"
      set_fact:
        server_ip_address: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
      tags: [rpm]
    
    - name: "RLM | Чтение секретов из secrets_vault_agent.json (созданного Vault Agent)"
      slurp:
        src: "/dev/shm/monitoring_secrets/secrets_vault_agent.json"
      register: secrets_content
      become: yes
      become_user: "{{ monitoring_service_user }}"
      delegate_to: "{{ inventory_hostname }}"
      tags: [rpm]
    
    - name: "RLM | Парсинг секретов из JSON"
      set_fact:
        secrets_data: "{{ secrets_content.content | b64decode | from_json }}"
      tags: [rpm]
    
    - name: "RLM | Информация о RPM URLs для установки"
      debug:
        msg: |
          RPM пакеты для установки:
            - Prometheus: {{ secrets_data.rpm_url.prometheus | default('NOT SET') }}
            - Grafana: {{ secrets_data.rpm_url.grafana | default('NOT SET') }}
            - Harvest: {{ secrets_data.rpm_url.harvest | default('NOT SET') }}
      tags: [rpm]
    
    # =========================================================================
    # УСТАНОВКА RPM ПАКЕТОВ ПОСЛЕДОВАТЕЛЬНО (НЕ ПАРАЛЛЕЛЬНО!)
    # RLM не может обрабатывать несколько задач на одном сервере одновременно
    # =========================================================================
    
    - name: "RLM | Установка Prometheus"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            url: "{{ secrets_data.rpm_url.prometheus }}"
            reinstall_is_allowed: true
          start_at: "now"
          service: "LINUX_RPM_INSTALLER"
          items:
            - table_id: "linuxrpminstallertable"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: prometheus_install_task
      tags: [rpm, prometheus]
    
    - name: "RLM | Мониторинг установки Prometheus"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ prometheus_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: prometheus_status
      until: prometheus_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: prometheus_status.json.status in ['failed', 'error']
      tags: [rpm, prometheus]
    
    - name: "RLM | Установка Grafana"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            url: "{{ secrets_data.rpm_url.grafana }}"
            reinstall_is_allowed: true
          start_at: "now"
          service: "LINUX_RPM_INSTALLER"
          items:
            - table_id: "linuxrpminstallertable"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: grafana_install_task
      tags: [rpm, grafana]
    
    - name: "RLM | Мониторинг установки Grafana"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ grafana_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: grafana_status
      until: grafana_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: grafana_status.json.status in ['failed', 'error']
      tags: [rpm, grafana]
    
    - name: "RLM | Установка Harvest"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            url: "{{ secrets_data.rpm_url.harvest }}"
            reinstall_is_allowed: true
          start_at: "now"
          service: "LINUX_RPM_INSTALLER"
          items:
            - table_id: "linuxrpminstallertable"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: harvest_install_task
      tags: [rpm, harvest]
    
    - name: "RLM | Мониторинг установки Harvest"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ harvest_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: harvest_status
      until: harvest_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: harvest_status.json.status in ['failed', 'error']
      tags: [rpm, harvest]

# ==============================================================================
# ЭТАП 3: Установка и настройка Prometheus
# ==============================================================================

- name: "ЭТАП 3: Установка и настройка Prometheus"
  hosts: all
  gather_facts: no
  become: yes
  tags: [prometheus, install]
  
  tasks:
    - name: "Prometheus | Копирование конфигурации"
      template:
        src: "../roles/prometheus/templates/prometheus.yml.j2"
        dest: "{{ monitoring_dirs.config }}/prometheus.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Prometheus | Копирование TLS конфигурации"
      template:
        src: "../roles/prometheus/templates/web-config.yml.j2"
        dest: "{{ monitoring_dirs.config }}/web-config.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Prometheus | Копирование systemd unit"
      copy:
        src: "../../../systemd/prometheus.service"
        dest: "{{ systemd_user_dir }}/prometheus.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Prometheus | Перезагрузка systemd"
      systemd:
        daemon_reload: yes
        scope: user
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd]
    
    - name: "Prometheus | Проверка текущего статуса сервиса"
      systemd:
        name: prometheus
        scope: user
      register: prometheus_status
      failed_when: false
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd, service]
    
    - name: "Prometheus | Информация о статусе"
      debug:
        msg: "Prometheus service: {{ prometheus_status.status.ActiveState | default('unknown') }}"
      tags: [systemd, service]
    
    - name: "Prometheus | Запуск сервиса (если не запущен)"
      systemd:
        name: prometheus
        state: started
        enabled: yes
        daemon_reload: yes
        scope: user
      when: 
        - deployment.restart_services | default(true)
        - prometheus_status.status.ActiveState is not defined or prometheus_status.status.ActiveState != 'active'
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd, service]

# ==============================================================================
# ЭТАП 4: Установка и настройка Grafana
# ==============================================================================

- name: "ЭТАП 4: Установка и настройка Grafana"
  hosts: all
  gather_facts: no
  become: yes
  tags: [grafana, install]
  
  tasks:
    - name: "Grafana | Копирование конфигурации"
      template:
        src: "../roles/grafana/templates/grafana.ini.j2"
        dest: "{{ monitoring_dirs.config }}/grafana.ini"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Grafana | Копирование systemd unit"
      copy:
        src: "../../../systemd/grafana.service"
        dest: "{{ systemd_user_dir }}/grafana.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Grafana | Проверка текущего статуса сервиса"
      systemd:
        name: grafana
        scope: user
      register: grafana_status
      failed_when: false
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd, service]
    
    - name: "Grafana | Информация о статусе"
      debug:
        msg: "Grafana service: {{ grafana_status.status.ActiveState | default('unknown') }}"
      tags: [systemd, service]
    
    - name: "Grafana | Запуск сервиса (если не запущен)"
      systemd:
        name: grafana
        state: started
        enabled: yes
        daemon_reload: yes
        scope: user
      when:
        - deployment.restart_services | default(true)
        - grafana_status.status.ActiveState is not defined or grafana_status.status.ActiveState != 'active'
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd, service]

# ==============================================================================
# ЭТАП 5: Установка и настройка Harvest
# ==============================================================================

- name: "ЭТАП 5: Установка и настройка Harvest"
  hosts: all
  gather_facts: no
  become: yes
  tags: [harvest, install]
  
  tasks:
    - name: "Harvest | Копирование конфигурации"
      template:
        src: "../roles/harvest/templates/harvest.yml.j2"
        dest: "{{ monitoring_dirs.config }}/harvest.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Harvest | Копирование systemd unit"
      copy:
        src: "../../../systemd/harvest.service"
        dest: "{{ systemd_user_dir }}/harvest.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Harvest | Проверка текущего статуса сервиса"
      systemd:
        name: harvest
        scope: user
      register: harvest_status
      failed_when: false
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd, service]
    
    - name: "Harvest | Информация о статусе"
      debug:
        msg: "Harvest service: {{ harvest_status.status.ActiveState | default('unknown') }}"
      tags: [systemd, service]
    
    - name: "Harvest | Запуск сервиса (если не запущен)"
      systemd:
        name: harvest
        state: started
        enabled: yes
        daemon_reload: yes
        scope: user
      when:
        - deployment.restart_services | default(true)
        - harvest_status.status.ActiveState is not defined or harvest_status.status.ActiveState != 'active'
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd, service]

# ==============================================================================
# ЭТАП 6: Проверка безопасности и верификация
# ==============================================================================

- name: "ЭТАП 6: Проверка безопасности и верификация установки"
  hosts: all
  gather_facts: no
  become: yes
  become_user: root
  tags: [verify, check]
  
  tasks:
    - name: "Проверка | Запуск скрипта проверки безопасности"
      command: >
        bash {{ monitoring_dirs.scripts }}/verify_security.sh
        {{ monitoring_service_user }}
        {{ monitoring_admin_user }}
        {{ monitoring_ci_user }}
        {{ monitoring_ro_user }}
      register: security_check
      failed_when: security_check.rc != 0
      when: deployment.run_security_checks | default(true)
      tags: [security]
    
    - name: "Проверка | Вывод результатов проверки безопасности"
      debug:
        var: security_check.stdout_lines
      when: security_check is defined
      tags: [security]
    
    - name: "Проверка | Статус сервисов"
      command: systemctl --user is-active {{ item }}
      loop:
        - prometheus
        - grafana
        - harvest
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      register: service_status
      changed_when: false
      failed_when: false
      tags: [service]
    
    - name: "Проверка | Вывод статуса сервисов"
      debug:
        msg: "Сервис {{ item.item }}: {{ 'АКТИВЕН' if item.rc == 0 else 'НЕ АКТИВЕН' }}"
      loop: "{{ service_status.results }}"
      tags: [service]
    
    - name: "Проверка | Доступность портов"
      wait_for:
        host: localhost
        port: "{{ item }}"
        timeout: 10
        state: started
      loop:
        - "{{ prometheus_port }}"
        - "{{ grafana_port }}"
        - "{{ harvest_netapp_port }}"
      failed_when: false
      tags: [network]

# ==============================================================================
# ФИНАЛЬНЫЙ ОТЧЕТ
# ==============================================================================

- name: "Финальный отчет о развертывании"
  hosts: all
  gather_facts: no
  tags: [always]
  
  tasks:
    - name: "Отчет | Итоговая информация"
      debug:
        msg:
          - "=========================================="
          - "РАЗВЕРТЫВАНИЕ ЗАВЕРШЕНО"
          - "=========================================="
          - "Сервер: {{ inventory_hostname }}"
          - "IP: {{ ansible_default_ipv4.address | default(ansible_host) }}"
          - ""
          - "Доступ к сервисам:"
          - "  Prometheus: https://{{ ansible_host }}:{{ prometheus_port }}"
          - "  Grafana: https://{{ ansible_host }}:{{ grafana_port }}"
          - "  Harvest: https://{{ ansible_host }}:{{ harvest_netapp_port }}/metrics"
          - ""
          - "Логи:"
          - "  journalctl --user -u prometheus -f"
          - "  journalctl --user -u grafana -f"
          - "  journalctl --user -u harvest -f"
          - "=========================================="



