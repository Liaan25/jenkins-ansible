---
# ==============================================================================
# Главный Playbook для развертывания системы мониторинга
# ==============================================================================
# 
# Описание:
#   Полное развертывание безопасной системы мониторинга (Prometheus + Grafana + Harvest)
#   с соблюдением всех корпоративных требований безопасности
#
# Использование:
#   ansible-playbook -i inventories/production playbooks/deploy_monitoring.yml
#
# Дополнительные параметры:
#   --extra-vars "netapp_api_addr=netapp-cluster.example.com"
#   --extra-vars "rlm_token=YOUR_RLM_TOKEN"
#   --tags "setup,config"  # Выполнить только определенные теги
#   --check                # Dry-run режим
#   --diff                 # Показать изменения
#
# ==============================================================================

- name: "Предварительные проверки"
  hosts: all
  gather_facts: yes
  become: no
  tags: [always]
  
  tasks:
    - name: "Проверка подключения к серверам"
      ping:
    
    # SECURITY: Проверка ansible_user удалена - безопасность обеспечивается через:
    # 1. SSH ключ аутентификация (контролируется Jenkins credentials)
    # 2. sudo права (контролируются через sudoers с явными путями)
    # 3. Все задачи используют become с конкретными пользователями
    
    - name: "Вывод информации о развертывании"
      debug:
        msg:
          - "=========================================="
          - "РАЗВЕРТЫВАНИЕ СИСТЕМЫ МОНИТОРИНГА"
          - "=========================================="
          - "Целевой сервер: {{ inventory_hostname }}"
          - "IP адрес: {{ ansible_default_ipv4.address | default('N/A') }}"
          - "Пользователь: {{ ansible_user }}"
          - "Базовая директория: {{ monitoring_base_dir }}"
          - "=========================================="

# ==============================================================================
# ЭТАП 1: Подготовка сервера
# ==============================================================================

- name: "ЭТАП 1: Подготовка инфраструктуры"
  hosts: all
  gather_facts: yes
  become: yes
  become_user: root
  tags: [setup, prepare]
  
  roles:
    - role: common
      tags: [common]

# ==============================================================================
# ЭТАП 1.5: Установка ПО через RLM API
# ==============================================================================

- name: "ЭТАП 1.5: Установка ПО через RLM API"
  hosts: all
  gather_facts: yes
  become: no
  tags: [install, rlm]
  
  tasks:
    - name: "RLM | Получение IP адреса сервера (если передан FQDN)"
      set_fact:
        server_ip_address: "{{ ansible_default_ipv4.address }}"
      tags: [vault, rpm]
    
    - name: "RLM | Чтение секретов из secrets.json (включая RPM URLs)"
      slurp:
        src: "{{ secrets_json_path }}"
      register: secrets_content
      become: yes
      become_user: "{{ monitoring_service_user }}"
      tags: [vault, rpm]
    
    - name: "RLM | Парсинг секретов из JSON"
      set_fact:
        secrets_data: "{{ secrets_content.content | b64decode | from_json }}"
      tags: [vault, rpm]
    
    - name: "RLM | Информация о сервере и секретах для RLM"
      debug:
        msg: |
          RLM параметры:
            - IP: {{ server_ip_address }}
            - SEC_MAN_ADDR: {{ sec_man_addr | upper }}
            - Namespace: {{ vault_namespace }}
            - Prometheus RPM: {{ secrets_data.rpm_url.prometheus | default('NOT SET') }}
            - Grafana RPM: {{ secrets_data.rpm_url.grafana | default('NOT SET') }}
            - Harvest RPM: {{ secrets_data.rpm_url.harvest | default('NOT SET') }}
            - Skip Vault Agent: {{ skip_rlm_vault_agent | default(false) }}
      tags: [vault, rpm]
    
    - name: "RLM | ПРОПУСК установки Vault Agent (параметр SKIP_RLM_VAULT_AGENT=true)"
      debug:
        msg: "⚠️  Vault Agent НЕ будет установлен через RLM. Убедитесь что он уже установлен вручную!"
      when: skip_rlm_vault_agent | default(false) | bool
      tags: [vault]
    
    - name: "RLM | Установка Vault Agent через RLM сценарий"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            v_url: "{{ sec_man_addr | upper }}"
            tenant: "{{ vault_namespace }}"
            serv_user: "{{ vault_agent_user }}"
            serv_group: "{{ vault_agent_group }}"
            read_user: "{{ vault_agent_user }}"
            approle: "approle/vault-agent"
            start_after_configuration: false
            log_num: 5
            log_size: 5
            log_level: "info"
            config_unwrapped: true
            skip_sm_conflicts: false
            templates:
              - source:
                  file_name: null
                  content: null
                destination:
                  path: null
          start_at: "now"
          service: "vault_agent_config"
          items:
            - table_id: "secmanserver"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: vault_install_task
      when: not (skip_rlm_vault_agent | default(false) | bool)
      tags: [vault]
    
    - name: "RLM | Мониторинг установки Vault Agent (ожидание завершения)"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ vault_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: vault_status
      until: vault_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: vault_status.json.status in ['failed', 'error']
      when: not (skip_rlm_vault_agent | default(false) | bool)
      tags: [vault]
    
    # =========================================================================
    # УСТАНОВКА RPM ПАКЕТОВ ПОСЛЕДОВАТЕЛЬНО (НЕ ПАРАЛЛЕЛЬНО!)
    # RLM не может обрабатывать несколько задач на одном сервере одновременно
    # =========================================================================
    
    - name: "RLM | Установка Prometheus"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            url: "{{ secrets_data.rpm_url.prometheus }}"
            reinstall_is_allowed: true
          start_at: "now"
          service: "LINUX_RPM_INSTALLER"
          items:
            - table_id: "linuxrpminstallertable"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: prometheus_install_task
      tags: [rpm, prometheus]
    
    - name: "RLM | Мониторинг установки Prometheus"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ prometheus_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: prometheus_status
      until: prometheus_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: prometheus_status.json.status in ['failed', 'error']
      tags: [rpm, prometheus]
    
    - name: "RLM | Установка Grafana"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            url: "{{ secrets_data.rpm_url.grafana }}"
            reinstall_is_allowed: true
          start_at: "now"
          service: "LINUX_RPM_INSTALLER"
          items:
            - table_id: "linuxrpminstallertable"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: grafana_install_task
      tags: [rpm, grafana]
    
    - name: "RLM | Мониторинг установки Grafana"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ grafana_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: grafana_status
      until: grafana_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: grafana_status.json.status in ['failed', 'error']
      tags: [rpm, grafana]
    
    - name: "RLM | Установка Harvest"
      uri:
        url: "{{ rlm_api_url }}/api/tasks.json"
        method: POST
        headers:
          Authorization: "Token {{ rlm_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          params:
            url: "{{ secrets_data.rpm_url.harvest }}"
            reinstall_is_allowed: true
          start_at: "now"
          service: "LINUX_RPM_INSTALLER"
          items:
            - table_id: "linuxrpminstallertable"
              invsvm_ip: "{{ server_ip_address }}"
        status_code: [200, 201]
        validate_certs: no
      register: harvest_install_task
      tags: [rpm, harvest]
    
    - name: "RLM | Мониторинг установки Harvest"
      uri:
        url: "{{ rlm_api_url }}/api/tasks/{{ harvest_install_task.json.id }}/"
        method: GET
        headers:
          Authorization: "Token {{ rlm_token }}"
        validate_certs: no
      register: harvest_status
      until: harvest_status.json.status in ['success', 'failed', 'error']
      retries: 120
      delay: 10
      failed_when: harvest_status.json.status in ['failed', 'error']
      tags: [rpm, harvest]

# ==============================================================================
# ЭТАП 2: Проверка Vault Agent и получение секретов
# ==============================================================================

- name: "ЭТАП 2: Проверка Vault Agent и получение секретов"
  hosts: all
  gather_facts: no
  become: yes
  become_user: root
  tags: [vault, secrets]
  
  tasks:
    - name: "Vault | Получение UID пользователя monitoring_service_user (через getent)"
      getent:
        database: passwd
        key: "{{ monitoring_service_user }}"
      register: monitoring_user_info
      tags: [setup, systemd]
    
    - name: "Vault | Установка переменной monitoring_service_user_uid"
      set_fact:
        monitoring_service_user_uid: "{{ getent_passwd[monitoring_service_user][1] }}"
      tags: [setup, systemd]
    
    - name: "Vault | Проверка что Vault Agent service запущен (установлен через RLM)"
      systemd:
        name: vault-agent
        state: started
      check_mode: yes
      register: vault_agent_status
      failed_when: false
      tags: [check]
    
    - name: "Vault | Информация о статусе Vault Agent"
      debug:
        msg: "Vault Agent service {{ 'запущен' if vault_agent_status.status.ActiveState == 'active' else 'не запущен или не установлен' }}"
      tags: [check]
    
    - name: "Vault | Ожидание получения сертификатов от Vault Agent"
      wait_for:
        path: "/opt/vault/certs/server_bundle.pem"
        timeout: 300
      tags: [wait]
    
    - name: "Vault | Проверка наличия полученных сертификатов"
      stat:
        path: "{{ item }}"
      loop:
        - "/opt/vault/certs/server_bundle.pem"
        - "/opt/vault/certs/ca_chain.crt"
      register: vault_certs_check
      tags: [check]
    
    - name: "Vault | Вывод информации о сертификатах"
      debug:
        msg: "Сертификат {{ item.item }} {{ 'найден' if item.stat.exists else 'НЕ найден' }}"
      loop: "{{ vault_certs_check.results }}"
      tags: [check]

# ==============================================================================
# ЭТАП 3: Установка и настройка Prometheus
# ==============================================================================

- name: "ЭТАП 3: Установка и настройка Prometheus"
  hosts: all
  gather_facts: no
  become: yes
  tags: [prometheus, install]
  
  tasks:
    - name: "Prometheus | Копирование конфигурации"
      template:
        src: "../roles/prometheus/templates/prometheus.yml.j2"
        dest: "{{ monitoring_dirs.config }}/prometheus.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Prometheus | Копирование TLS конфигурации"
      template:
        src: "../roles/prometheus/templates/web-config.yml.j2"
        dest: "{{ monitoring_dirs.config }}/web-config.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Prometheus | Копирование systemd unit"
      copy:
        src: "../../../systemd/prometheus.service"
        dest: "{{ systemd_user_dir }}/prometheus.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Prometheus | Перезагрузка systemd"
      systemd:
        daemon_reload: yes
        scope: user
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd]
    
    - name: "Prometheus | Запуск сервиса"
      systemd:
        name: prometheus
        state: started
        enabled: yes
        scope: user
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      when: deployment.restart_services | default(true)
      tags: [service]

# ==============================================================================
# ЭТАП 4: Установка и настройка Grafana
# ==============================================================================

- name: "ЭТАП 4: Установка и настройка Grafana"
  hosts: all
  gather_facts: no
  become: yes
  tags: [grafana, install]
  
  tasks:
    - name: "Grafana | Копирование конфигурации"
      template:
        src: "../roles/grafana/templates/grafana.ini.j2"
        dest: "{{ monitoring_dirs.config }}/grafana.ini"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Grafana | Копирование systemd unit"
      copy:
        src: "../../../systemd/grafana.service"
        dest: "{{ systemd_user_dir }}/grafana.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Grafana | Запуск сервиса"
      systemd:
        name: grafana
        state: started
        enabled: yes
        scope: user
        daemon_reload: yes
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      when: deployment.restart_services | default(true)
      tags: [service]

# ==============================================================================
# ЭТАП 5: Установка и настройка Harvest
# ==============================================================================

- name: "ЭТАП 5: Установка и настройка Harvest"
  hosts: all
  gather_facts: no
  become: yes
  tags: [harvest, install]
  
  tasks:
    - name: "Harvest | Копирование конфигурации"
      template:
        src: "../roles/harvest/templates/harvest.yml.j2"
        dest: "{{ monitoring_dirs.config }}/harvest.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Harvest | Копирование systemd unit"
      copy:
        src: "../../../systemd/harvest.service"
        dest: "{{ systemd_user_dir }}/harvest.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Harvest | Запуск сервиса"
      systemd:
        name: harvest
        state: started
        enabled: yes
        scope: user
        daemon_reload: yes
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      when: deployment.restart_services | default(true)
      tags: [service]

# ==============================================================================
# ЭТАП 6: Проверка безопасности и верификация
# ==============================================================================

- name: "ЭТАП 6: Проверка безопасности и верификация установки"
  hosts: all
  gather_facts: no
  become: yes
  become_user: root
  tags: [verify, check]
  
  tasks:
    - name: "Проверка | Запуск скрипта проверки безопасности"
      command: bash {{ monitoring_dirs.scripts }}/verify_security.sh
      register: security_check
      failed_when: security_check.rc != 0
      when: deployment.run_security_checks | default(true)
      tags: [security]
    
    - name: "Проверка | Вывод результатов проверки безопасности"
      debug:
        var: security_check.stdout_lines
      when: security_check is defined
      tags: [security]
    
    - name: "Проверка | Статус сервисов"
      command: systemctl --user is-active {{ item }}
      loop:
        - prometheus
        - grafana
        - harvest
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      register: service_status
      changed_when: false
      failed_when: false
      tags: [service]
    
    - name: "Проверка | Вывод статуса сервисов"
      debug:
        msg: "Сервис {{ item.item }}: {{ 'АКТИВЕН' if item.rc == 0 else 'НЕ АКТИВЕН' }}"
      loop: "{{ service_status.results }}"
      tags: [service]
    
    - name: "Проверка | Доступность портов"
      wait_for:
        host: localhost
        port: "{{ item }}"
        timeout: 10
        state: started
      loop:
        - "{{ prometheus_port }}"
        - "{{ grafana_port }}"
        - "{{ harvest_netapp_port }}"
      failed_when: false
      tags: [network]

# ==============================================================================
# ФИНАЛЬНЫЙ ОТЧЕТ
# ==============================================================================

- name: "Финальный отчет о развертывании"
  hosts: all
  gather_facts: no
  tags: [always]
  
  tasks:
    - name: "Отчет | Итоговая информация"
      debug:
        msg:
          - "=========================================="
          - "РАЗВЕРТЫВАНИЕ ЗАВЕРШЕНО"
          - "=========================================="
          - "Сервер: {{ inventory_hostname }}"
          - "IP: {{ ansible_default_ipv4.address | default(ansible_host) }}"
          - ""
          - "Доступ к сервисам:"
          - "  Prometheus: https://{{ ansible_host }}:{{ prometheus_port }}"
          - "  Grafana: https://{{ ansible_host }}:{{ grafana_port }}"
          - "  Harvest: https://{{ ansible_host }}:{{ harvest_netapp_port }}/metrics"
          - ""
          - "Логи:"
          - "  journalctl --user -u prometheus -f"
          - "  journalctl --user -u grafana -f"
          - "  journalctl --user -u harvest -f"
          - "=========================================="



