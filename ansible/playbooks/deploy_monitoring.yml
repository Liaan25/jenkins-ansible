---
# ==============================================================================
# Главный Playbook для развертывания системы мониторинга
# ==============================================================================
# 
# Описание:
#   Полное развертывание безопасной системы мониторинга (Prometheus + Grafana + Harvest)
#   с соблюдением всех корпоративных требований безопасности
#
# Использование:
#   ansible-playbook -i inventories/production playbooks/deploy_monitoring.yml
#
# Дополнительные параметры:
#   --extra-vars "netapp_api_addr=netapp-cluster.example.com"
#   --extra-vars "rlm_token=YOUR_RLM_TOKEN"
#   --tags "setup,config"  # Выполнить только определенные теги
#   --check                # Dry-run режим
#   --diff                 # Показать изменения
#
# ==============================================================================

- name: "Предварительные проверки"
  hosts: monitoring_servers
  gather_facts: yes
  become: no
  tags: [always]
  
  tasks:
    - name: "Проверка подключения к серверам"
      ping:
    
    - name: "Проверка что запущено от пользователя monitoring_ci"
      assert:
        that:
          - ansible_user == monitoring_ci_user
        fail_msg: "Playbook должен запускаться от пользователя {{ monitoring_ci_user }}"
        success_msg: "Пользователь корректен: {{ ansible_user }}"
    
    - name: "Вывод информации о развертывании"
      debug:
        msg:
          - "=========================================="
          - "РАЗВЕРТЫВАНИЕ СИСТЕМЫ МОНИТОРИНГА"
          - "=========================================="
          - "Целевой сервер: {{ inventory_hostname }}"
          - "IP адрес: {{ ansible_default_ipv4.address | default('N/A') }}"
          - "Пользователь: {{ ansible_user }}"
          - "Базовая директория: {{ monitoring_base_dir }}"
          - "=========================================="

# ==============================================================================
# ЭТАП 1: Подготовка сервера
# ==============================================================================

- name: "ЭТАП 1: Подготовка инфраструктуры"
  hosts: monitoring_servers
  gather_facts: yes
  become: yes
  become_user: root
  tags: [setup, prepare]
  
  roles:
    - role: common
      tags: [common]

# ==============================================================================
# ЭТАП 2: Настройка Vault Agent
# ==============================================================================

- name: "ЭТАП 2: Настройка Vault Agent для управления секретами"
  hosts: monitoring_servers
  gather_facts: no
  become: yes
  become_user: "{{ monitoring_service_user }}"
  tags: [vault, secrets]
  
  tasks:
    - name: "Vault | Проверка наличия AppRole credentials"
      stat:
        path: "{{ item }}"
      loop:
        - "{{ vault_role_id_file }}"
        - "{{ vault_secret_id_file }}"
      register: vault_creds_check
      tags: [check]
    
    - name: "Vault | Предупреждение если credentials отсутствуют"
      debug:
        msg: "WARNING: AppRole credentials не найдены. Vault Agent не сможет запуститься."
      when: vault_creds_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
      tags: [check]
    
    - name: "Vault | Копирование конфигурации Vault Agent"
      template:
        src: "../config/vault-agent.hcl.j2"
        dest: "{{ vault_conf_dir }}/agent.hcl"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0640"
      become: yes
      become_user: root
      when: vault_creds_check.results | selectattr('stat.exists', 'equalto', true) | list | length == 2
      tags: [config]
    
    - name: "Vault | Копирование systemd unit для Vault Agent"
      copy:
        src: "../../../systemd/vault-agent-monitoring.service"
        dest: "{{ systemd_user_dir }}/vault-agent-monitoring.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      tags: [systemd]
    
    - name: "Vault | Перезагрузка systemd daemon"
      systemd:
        daemon_reload: yes
        scope: user
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid }}"
      tags: [systemd]
    
    - name: "Vault | Запуск Vault Agent"
      systemd:
        name: vault-agent-monitoring
        state: started
        enabled: yes
        scope: user
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid }}"
      when: vault_creds_check.results | selectattr('stat.exists', 'equalto', true) | list | length == 2
      tags: [service]
    
    - name: "Vault | Ожидание получения секретов"
      wait_for:
        path: "{{ secrets_dir }}/server.crt"
        timeout: "{{ timeouts.vault_agent_wait }}"
      when: vault_creds_check.results | selectattr('stat.exists', 'equalto', true) | list | length == 2
      tags: [wait]

# ==============================================================================
# ЭТАП 3: Установка и настройка Prometheus
# ==============================================================================

- name: "ЭТАП 3: Установка и настройка Prometheus"
  hosts: monitoring_servers
  gather_facts: no
  become: yes
  tags: [prometheus, install]
  
  tasks:
    - name: "Prometheus | Копирование конфигурации"
      template:
        src: "../config/prometheus.yml.j2"
        dest: "{{ monitoring_dirs.config }}/prometheus.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Prometheus | Копирование TLS конфигурации"
      template:
        src: "../config/prometheus-web-config.yml.j2"
        dest: "{{ monitoring_dirs.config }}/web-config.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Prometheus | Копирование systemd unit"
      copy:
        src: "../../../systemd/prometheus.service"
        dest: "{{ systemd_user_dir }}/prometheus.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Prometheus | Перезагрузка systemd"
      systemd:
        daemon_reload: yes
        scope: user
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      tags: [systemd]
    
    - name: "Prometheus | Запуск сервиса"
      systemd:
        name: prometheus
        state: started
        enabled: yes
        scope: user
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      when: deployment.restart_services | default(true)
      tags: [service]

# ==============================================================================
# ЭТАП 4: Установка и настройка Grafana
# ==============================================================================

- name: "ЭТАП 4: Установка и настройка Grafana"
  hosts: monitoring_servers
  gather_facts: no
  become: yes
  tags: [grafana, install]
  
  tasks:
    - name: "Grafana | Копирование конфигурации"
      template:
        src: "../config/grafana.ini.j2"
        dest: "{{ monitoring_dirs.config }}/grafana.ini"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Grafana | Копирование systemd unit"
      copy:
        src: "../../../systemd/grafana.service"
        dest: "{{ systemd_user_dir }}/grafana.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Grafana | Запуск сервиса"
      systemd:
        name: grafana
        state: started
        enabled: yes
        scope: user
        daemon_reload: yes
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      when: deployment.restart_services | default(true)
      tags: [service]

# ==============================================================================
# ЭТАП 5: Установка и настройка Harvest
# ==============================================================================

- name: "ЭТАП 5: Установка и настройка Harvest"
  hosts: monitoring_servers
  gather_facts: no
  become: yes
  tags: [harvest, install]
  
  tasks:
    - name: "Harvest | Копирование конфигурации"
      template:
        src: "../config/harvest.yml.j2"
        dest: "{{ monitoring_dirs.config }}/harvest.yml"
        owner: "{{ monitoring_ci_user }}"
        group: "{{ monitoring_group }}"
        mode: "{{ file_permissions.config }}"
      become_user: root
      tags: [config]
    
    - name: "Harvest | Копирование systemd unit"
      copy:
        src: "../../../systemd/harvest.service"
        dest: "{{ systemd_user_dir }}/harvest.service"
        owner: "{{ monitoring_service_user }}"
        group: "{{ monitoring_group }}"
        mode: "0644"
      become_user: "{{ monitoring_service_user }}"
      tags: [systemd]
    
    - name: "Harvest | Запуск сервиса"
      systemd:
        name: harvest
        state: started
        enabled: yes
        scope: user
        daemon_reload: yes
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      when: deployment.restart_services | default(true)
      tags: [service]

# ==============================================================================
# ЭТАП 6: Проверка безопасности и верификация
# ==============================================================================

- name: "ЭТАП 6: Проверка безопасности и верификация установки"
  hosts: monitoring_servers
  gather_facts: no
  become: yes
  become_user: root
  tags: [verify, check]
  
  tasks:
    - name: "Проверка | Запуск скрипта проверки безопасности"
      command: bash {{ monitoring_dirs.scripts }}/verify_security.sh
      register: security_check
      failed_when: security_check.rc != 0
      when: deployment.run_security_checks | default(true)
      tags: [security]
    
    - name: "Проверка | Вывод результатов проверки безопасности"
      debug:
        var: security_check.stdout_lines
      when: security_check is defined
      tags: [security]
    
    - name: "Проверка | Статус сервисов"
      command: systemctl --user is-active {{ item }}
      loop:
        - prometheus
        - grafana
        - harvest
      become_user: "{{ monitoring_service_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ monitoring_service_user_uid }}"
      register: service_status
      changed_when: false
      failed_when: false
      tags: [service]
    
    - name: "Проверка | Вывод статуса сервисов"
      debug:
        msg: "Сервис {{ item.item }}: {{ 'АКТИВЕН' if item.rc == 0 else 'НЕ АКТИВЕН' }}"
      loop: "{{ service_status.results }}"
      tags: [service]
    
    - name: "Проверка | Доступность портов"
      wait_for:
        host: localhost
        port: "{{ item }}"
        timeout: 10
        state: started
      loop:
        - "{{ prometheus_port }}"
        - "{{ grafana_port }}"
        - "{{ harvest_netapp_port }}"
      failed_when: false
      tags: [network]

# ==============================================================================
# ФИНАЛЬНЫЙ ОТЧЕТ
# ==============================================================================

- name: "Финальный отчет о развертывании"
  hosts: monitoring_servers
  gather_facts: no
  tags: [always]
  
  tasks:
    - name: "Отчет | Итоговая информация"
      debug:
        msg:
          - "=========================================="
          - "РАЗВЕРТЫВАНИЕ ЗАВЕРШЕНО"
          - "=========================================="
          - "Сервер: {{ inventory_hostname }}"
          - "IP: {{ ansible_default_ipv4.address | default(ansible_host) }}"
          - ""
          - "Доступ к сервисам:"
          - "  Prometheus: https://{{ ansible_host }}:{{ prometheus_port }}"
          - "  Grafana: https://{{ ansible_host }}:{{ grafana_port }}"
          - "  Harvest: https://{{ ansible_host }}:{{ harvest_netapp_port }}/metrics"
          - ""
          - "Логи:"
          - "  journalctl --user -u prometheus -f"
          - "  journalctl --user -u grafana -f"
          - "  journalctl --user -u harvest -f"
          - "=========================================="


