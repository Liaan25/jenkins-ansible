pid_file = "/opt/vault/log/vault-agent.pidfile"

vault {
  address = "https://{{ sec_man_addr }}"
  tls_skip_verify = "false"
  ca_path = "/opt/vault/conf/ca-trust"
}

auto_auth {
  method "approle" {
    namespace = "{{ vault_namespace }}"
    mount_path = "auth/approle"
    
    config = {
      role_id_file_path = "/opt/vault/conf/role_id.txt"
      secret_id_file_path = "/opt/vault/conf/secret_id.txt"
      remove_secret_id_file_after_reading = false
    }
  }
}

log_destination "Tengry" {
  log_format = "json"
  log_path = "/opt/vault/log"
  log_rotate = "5"
  log_max_size = "5mb"
  log_level = "info"
  log_file = "agent.log"
}

# =============================================================================
# TEMPLATE: secrets_vault_agent.json
# =============================================================================
# Vault Agent извлекает ВСЕ секреты напрямую из Vault
# Jenkins передает только role_id + secret_id для аутентификации
# Результат: /dev/shm/monitoring_secrets/secrets_vault_agent.json
# =============================================================================
template {
  destination = "/dev/shm/monitoring_secrets/secrets_vault_agent.json"
  contents = <<EOT
{% raw %}
{
  "rpm_url": {
    {{- with secret {% endraw %}"{{ rpm_url_kv }}"{% raw %} -}}
    "harvest": {{ .Data.harvest | toJSON }},
    "prometheus": {{ .Data.prometheus | toJSON }},
    "grafana": {{ .Data.grafana | toJSON }}
    {{- end -}}
  }{% endraw %}{% if tuz_kv is defined and tuz_kv != 'null' and tuz_kv != '' %},{% raw %}
  "tuz": {
    {{- with secret {% endraw %}"{{ tuz_kv }}"{% raw %} -}}
    "pass": {{ .Data.pass | toJSON }},
    "user": {{ .Data.user | toJSON }}
    {{- end -}}
  }{% endraw %}{% endif %}{% if netapp_ssh_kv is defined and netapp_ssh_kv != 'null' and netapp_ssh_kv != '' %},{% raw %}
  "netapp_ssh": {
    {{- with secret {% endraw %}"{{ netapp_ssh_kv }}"{% raw %} -}}
    "addr": {{ .Data.addr | toJSON }},
    "user": {{ .Data.user | toJSON }},
    "pass": {{ .Data.pass | toJSON }}
    {{- end -}}
  }{% endraw %}{% endif %}{% if mon_ssh_kv is defined and mon_ssh_kv != 'null' and mon_ssh_kv != '' %},{% raw %}
  "mon_ssh": {
    {{- with secret {% endraw %}"{{ mon_ssh_kv }}"{% raw %} -}}
    "addr": {{ .Data.addr | toJSON }},
    "user": {{ .Data.user | toJSON }},
    "pass": {{ .Data.pass | toJSON }}
    {{- end -}}
  }{% endraw %}{% endif %}{% if netapp_api_kv is defined and netapp_api_kv != 'null' and netapp_api_kv != '' %},{% raw %}
  "netapp_api": {
    {{- with secret {% endraw %}"{{ netapp_api_kv }}"{% raw %} -}}
    "addr": {{ .Data.addr | toJSON }},
    "user": {{ .Data.user | toJSON }},
    "pass": {{ .Data.pass | toJSON }}
    {{- end -}}
  }{% endraw %}{% endif %}{% if grafana_web_kv is defined and grafana_web_kv != 'null' and grafana_web_kv != '' %},{% raw %}
  "grafana_web": {
    {{- with secret {% endraw %}"{{ grafana_web_kv }}"{% raw %} -}}
    "user": {{ .Data.user | toJSON }},
    "pass": {{ .Data.pass | toJSON }}
    {{- end -}}
  }{% endraw %}{% endif %}{% raw %}
}
{% endraw %}
EOT
  perms = "0640"
  error_on_missing_key = true
}

# =============================================================================
# TEMPLATE: TLS Certificate Bundle
# =============================================================================
# Vault Agent генерирует TLS сертификаты через PKI backend
# Используется для HTTPS в Prometheus, Grafana, Harvest
# =============================================================================
template {
  destination = "/opt/vault/certs/server_bundle.pem"
  contents = <<EOT
{% raw %}
{{- with secret {% endraw %}"{{ sberca_cert_kv }}"{% raw %} "common_name={% endraw %}{{ ansible_fqdn }}{% raw %}" "email={% endraw %}{{ admin_email }}{% raw %}" "alt_names={% endraw %}{{ ansible_fqdn }}{% raw %}" -}}
{{ .Data.private_key }}
{{ .Data.certificate }}
{{- end -}}
{% endraw %}
EOT
  perms = "0640"
  error_on_missing_key = true
}

# =============================================================================
# TEMPLATE: CA Chain
# =============================================================================
# CA цепочка для валидации сертификатов
# =============================================================================
template {
  destination = "/opt/vault/certs/ca_chain.crt"
  contents = <<EOT
{% raw %}
{{- with secret {% endraw %}"{{ sberca_cert_kv }}"{% raw %} "common_name={% endraw %}{{ ansible_fqdn }}{% raw %}" "email={% endraw %}{{ admin_email }}{% raw %}" "alt_names={% endraw %}{{ ansible_fqdn }}{% raw %}" -}}
{{ .Data.ca_chain }}
{{- end -}}
{% endraw %}
EOT
  perms = "0640"
  error_on_missing_key = true
}

