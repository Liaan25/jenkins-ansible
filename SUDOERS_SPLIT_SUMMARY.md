# Разделение файла sudoers по пользователям

## Что было сделано

Единый файл `sudoers/monitoring_system` был разделен на **4 отдельных файла** - по одному для каждого пользователя системы мониторинга.

## Созданные файлы

### 1. `sudoers/monitoring_ci` (ТУЗ - CI/CD)
- **Пользователь**: `monitoring_ci`
- **Тип**: Техническая учетная запись
- **Количество команд**: ~90
- **Назначение**: Автоматизированный деплой через Jenkins/Ansible

**Основные группы команд** (отсортированы по алфавиту):
- Переключение на `monitoring_svc`: `ALL=(monitoring_svc) NOPASSWD: ALL`
- Управление правами на директории (`chmod`)
- Управление владельцами файлов (`chown`)
- Копирование конфигураций (`cp`)
- Просмотр логов (`journalctl`)
- Проверка портов (`ss`, `lsof`)
- Создание директорий (`mkdir`)
- Управление systemd units (`systemctl --user`)

**Размещение**: `/etc/sudoers.d/monitoring_ci`

---

### 2. `sudoers/monitoring_admin` (ПУЗ - Администратор)
- **Пользователь**: `monitoring_admin`
- **Тип**: Привилегированная учетная запись
- **Количество команд**: ~35
- **Назначение**: Администрирование, диагностика, управление сервисами

**Основные группы команд** (отсортированы по алфавиту):
- Переключение на `monitoring_svc`: `ALL=(monitoring_svc) NOPASSWD: ALL`
- Создание бэкапов (`tar`)
- Диагностика (`df`, `ps`, `ss`, `lsof`)
- Просмотр логов (`journalctl`)
- Управление systemd units (`systemctl --user`)

**Размещение**: `/etc/sudoers.d/monitoring_admin`

---

### 3. `sudoers/monitoring_ro` (ReadOnly - Аудит)
- **Пользователь**: `monitoring_ro`
- **Тип**: ReadOnly учетная запись
- **Количество команд**: ~15
- **Назначение**: Только просмотр статуса и логов

**Основные группы команд** (отсортированы по алфавиту):
- Диагностика (только просмотр: `df`, `ps`, `ss`)
- Просмотр логов (`journalctl`)
- Просмотр статуса сервисов (`systemctl --user status`, `is-active`)

**БЕЗ** управления (нет `start`, `stop`, `restart`)!

**Размещение**: `/etc/sudoers.d/monitoring_ro`

---

### 4. `sudoers/monitoring_svc` (СУЗ - Сервис)
- **Пользователь**: `monitoring_svc`
- **Тип**: Сервисная учетная запись (NoLogin)
- **Количество команд**: **0** (файл содержит только документацию)
- **Назначение**: Запуск процессов Prometheus, Grafana, Harvest

**ВАЖНО**: Этот файл **НЕ нужно** размещать в `/etc/sudoers.d/`!

**Почему нет sudo прав:**
- NoLogin пользователь (не может войти в систему)
- Процессам не нужны повышенные права
- Управление через другие УЗ (`monitoring_ci`, `monitoring_admin`)
- Все необходимые права есть через владение директориями

**Размещение**: Только в проекте (для документации)

---

## Преимущества раздельных файлов

✅ **Гранулярность**: Каждый пользователь имеет отдельный файл  
✅ **Безопасность**: Легче аудитировать и контролировать права  
✅ **Сортировка**: Все команды отсортированы по алфавиту внутри категорий  
✅ **Управление**: Проще добавлять/удалять права конкретному пользователю  
✅ **IDM**: Возможность создавать отдельные заявки для каждого пользователя  
✅ **Читаемость**: Каждый файл фокусируется на одной роли  

## Сравнительная таблица

| Файл | Пользователь | Sudo команд | start/stop | create dirs | change owner | view logs |
|------|-------------|-------------|------------|-------------|--------------|-----------|
| `monitoring_ci` | ТУЗ | ~90 | ✅ | ✅ | ✅ | ✅ |
| `monitoring_admin` | ПУЗ | ~35 | ✅ | ❌ | ❌ | ✅ |
| `monitoring_ro` | ReadOnly | ~15 | ❌ | ❌ | ❌ | ✅ |
| `monitoring_svc` | СУЗ | **0** | ❌ | ❌ | ❌ | ❌ |

## Структура команд внутри каждого файла

Все команды внутри файлов организованы в **секции** и **отсортированы по алфавиту**:

```bash
# ==============================================================================
# ПЕРЕКЛЮЧЕНИЕ НА ДРУГОГО ПОЛЬЗОВАТЕЛЯ
# ==============================================================================

# ==============================================================================
# УПРАВЛЕНИЕ ПРАВАМИ НА ДИРЕКТОРИИ
# ==============================================================================

# ==============================================================================
# УПРАВЛЕНИЕ ВЛАДЕЛЬЦАМИ ФАЙЛОВ И ДИРЕКТОРИЙ
# ==============================================================================

# ==============================================================================
# КОПИРОВАНИЕ КОНФИГУРАЦИОННЫХ ФАЙЛОВ
# ==============================================================================

# ==============================================================================
# ПРОСМОТР ЛОГОВ (ДИАГНОСТИКА)
# ==============================================================================

# ==============================================================================
# ПРОВЕРКА ПОРТОВ И СЕТЕВЫХ СОЕДИНЕНИЙ
# ==============================================================================

# ==============================================================================
# СОЗДАНИЕ СТРУКТУРЫ ДИРЕКТОРИЙ
# ==============================================================================

# ==============================================================================
# УПРАВЛЕНИЕ USER SYSTEMD UNITS
# ==============================================================================
```

## Как использовать

### Вариант A: Отдельные заявки в IDM (рекомендуется)

Создать **3 отдельные заявки** в IDM:

1. **Заявка для `monitoring_ci`**:
   - Приложить файл: `sudoers/monitoring_ci`
   - Пользователь: `monitoring_ci`
   - Обоснование: Автоматизированный деплой через Jenkins/Ansible

2. **Заявка для `monitoring_admin`**:
   - Приложить файл: `sudoers/monitoring_admin`
   - Пользователь: `monitoring_admin`
   - Обоснование: Администрирование и диагностика системы

3. **Заявка для `monitoring_ro`**:
   - Приложить файл: `sudoers/monitoring_ro`
   - Пользователь: `monitoring_ro`
   - Обоснование: Аудит и мониторинг (только чтение)

**Для `monitoring_svc` заявку НЕ создавать!**

### Вариант B: Единая заявка (legacy)

Использовать единый файл `sudoers/monitoring_system` (для обратной совместимости):
- Приложить файл: `sudoers/monitoring_system`
- Пользователи: `monitoring_ci`, `monitoring_admin`, `monitoring_ro`

## Проверка синтаксиса

После размещения файлов в `/etc/sudoers.d/` обязательно проверить синтаксис:

```bash
sudo visudo -c -f /etc/sudoers.d/monitoring_ci
sudo visudo -c -f /etc/sudoers.d/monitoring_admin
sudo visudo -c -f /etc/sudoers.d/monitoring_ro
```

Ожидаемый вывод:
```
/etc/sudoers.d/monitoring_ci: parsed OK
/etc/sudoers.d/monitoring_admin: parsed OK
/etc/sudoers.d/monitoring_ro: parsed OK
```

## Миграция с единого файла

Если у вас уже размещен единый файл `/etc/sudoers.d/monitoring_system`:

```bash
# 1. Создать бэкап
sudo cp /etc/sudoers.d/monitoring_system /etc/sudoers.d/monitoring_system.backup

# 2. Разместить новые файлы
sudo cp sudoers/monitoring_ci /etc/sudoers.d/monitoring_ci
sudo cp sudoers/monitoring_admin /etc/sudoers.d/monitoring_admin
sudo cp sudoers/monitoring_ro /etc/sudoers.d/monitoring_ro

# 3. Проверить синтаксис всех файлов
sudo visudo -c -f /etc/sudoers.d/monitoring_ci
sudo visudo -c -f /etc/sudoers.d/monitoring_admin
sudo visudo -c -f /etc/sudoers.d/monitoring_ro

# 4. Протестировать права
sudo -u monitoring_ci -l  # Проверить список прав
sudo -u monitoring_admin -l
sudo -u monitoring_ro -l

# 5. Удалить старый файл (после успешного тестирования)
sudo rm /etc/sudoers.d/monitoring_system
```

## Обратная совместимость

Единый файл `sudoers/monitoring_system` **сохранен** в проекте для обратной совместимости и может использоваться если:
- IDM не поддерживает множественные файлы sudoers
- Требуется быстрое развертывание одной заявкой
- Корпоративная политика требует единого файла

## Документация

Подробная документация доступна в:
- `docs/SUDOERS_GUIDE.md` - Полное руководство по работе с sudoers
- `docs/IDM_ACCOUNTS_GUIDE.md` - Создание учетных записей через IDM
- `docs/SECURITY_MODEL.md` - Модель безопасности системы

---

**Дата создания**: 19.11.2024  
**Версия**: 1.0  
**Статус**: ✅ Готово к использованию





