# ะััะตั: ะะตะฐะปะธะทะฐัะธั ะดะธะฝะฐะผะธัะตัะบะพะน ะณััะฟะฟั (ะััะฟะฟะฐ = ะกะฃะ)

**ะะฐัะฐ**: 19.11.2024  
**ะะตััะธั**: 2.2  
**ะกัะฐััั**: โ ะะตะฐะปะธะทะพะฒะฐะฝะพ

---

## ๐ ะะฐะดะฐัะฐ

ะะตะฐะปะธะทะพะฒะฐัั **ะดะธะฝะฐะผะธัะตัะบัั ะณััะฟะฟั**, ะบะพัะพัะฐั ัะฐะฒะฝะฐ ะธะผะตะฝะธ **ัะตัะฒะธัะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั (ะกะฃะ)** ะฒะผะตััะพ ััะฐัะธัะตัะบะพะน ะณััะฟะฟั `monitoring`.

---

## โ ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ

### 1. **ะะฑะฝะพะฒะปะตะฝ `ansible/group_vars/monitoring.yml`**

**ะะทะผะตะฝะตะฝะธะต:**
```yaml
# ะะซะะ (ััะฐัะธัะตัะบะฐั ะณััะฟะฟะฐ):
monitoring_group: "monitoring"

# ะกะขะะะ (ะดะธะฝะฐะผะธัะตัะบะฐั ะณััะฟะฟะฐ = ะธะผั ะกะฃะ):
monitoring_group: "{{ user_sys | default(kae_stend + '-lnx-mon_sys') }}"
```

**ะะตะทัะปััะฐั:**
```yaml
# ะะปั ััะตะฝะดะฐ CI10742292:
monitoring_group: "CI10742292-lnx-mon_sys"

# ะะปั ััะตะฝะดะฐ DEV123456:
monitoring_group: "DEV123456-lnx-mon_sys"
```

---

### 2. **ะะฑะฝะพะฒะปะตะฝ `sudoers/monitoring_ci.template`**

**ะะทะผะตะฝะตะฝะธั:**
ะัะต ะบะพะผะฐะฝะดั `chown` ะพะฑะฝะพะฒะปะตะฝั ั `:monitoring` ะฝะฐ `:{{USER_SYS}}`:

```bash
# ะะซะะ:
{{USER_CI}} ALL=(ALL\:ALL) NOPASSWD: /usr/bin/chown {{USER_SYS}}\:monitoring /dev/shm/monitoring_secrets

# ะกะขะะะ:
{{USER_CI}} ALL=(ALL\:ALL) NOPASSWD: /usr/bin/chown {{USER_SYS}}\:{{USER_SYS}} /dev/shm/monitoring_secrets
```

**ะัะตะณะพ ะพะฑะฝะพะฒะปะตะฝะพ:** 13 ะบะพะผะฐะฝะด `chown`

---

### 3. **ะัะพะฒะตัะตะฝั templates sudoers**

โ `sudoers/monitoring_admin.template` - ะฝะต ััะตะฑัะตั ะธะทะผะตะฝะตะฝะธะน (ะฝะตั ะบะพะผะฐะฝะด chown)  
โ `sudoers/monitoring_ro.template` - ะฝะต ััะตะฑัะตั ะธะทะผะตะฝะตะฝะธะน (ะฝะตั ะบะพะผะฐะฝะด chown)  

---

### 4. **ะกะพะทะดะฐะฝะฐ ะดะพะบัะผะตะฝัะฐัะธั**

#### ะะพะฒัะน ะดะพะบัะผะตะฝั: `docs/DYNAMIC_GROUP_GUIDE.md` (392 ัััะพะบะธ)

**ะกะพะดะตัะถะฐะฝะธะต:**
- ะะพะฝัะตะฟัะธั (ะััะฟะฟะฐ = ะกะฃะ)
- ะกัะตะผะฐ ะดะปั ััะตะฝะดะฐ
- ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฒ IDM (ะฟะพััะดะพะบ!)
- ะกัััะบัััะฐ ะฟัะฐะฒ ะฝะฐ ัะฐะนะปั
- ะะตะทะพะฟะฐัะฝะพััั (ะธะทะพะปััะธั, ะบะพะฝััะพะปั ัะปะตะฝััะฒะฐ)
- ะัะพะฒะตัะบะฐ ะฝะฐัััะพะนะบะธ
- Ansible ะบะพะฝัะธะณััะฐัะธั
- ะะธะณัะฐัะธั ัะพ ััะฐัะธัะตัะบะพะน ะณััะฟะฟั
- ะงะตะบะปะธัั ะดะปั ะฒะฝะตะดัะตะฝะธั

#### ะะฑะฝะพะฒะปะตะฝ: `docs/IDM_ACCOUNTS_GUIDE.md`

**ะะพะฑะฐะฒะปะตะฝะพ:**
- ะกะตะบัะธั "ะััะฟะฟะฐ (ะดะธะฝะฐะผะธัะตัะบะฐั)" ั ะพะฑัััะฝะตะฝะธะตะผ ะบะพะฝัะตะฟัะธะธ
- ะัะตะดัะฟัะตะถะดะตะฝะธะต "ะกะฃะ ัะพะทะดะฐะตััั ะฟะตัะฒัะผ!"
- ะะฝััััะบัะธะธ ะฟะพ ัะบะฐะทะฐะฝะธั **Secondary Groups** ะดะปั ะฒัะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน (ะะฃะ, ะขะฃะ, ReadOnly)
- ะัะธัะธัะตัะบะธะต ะฟัะตะดัะฟัะตะถะดะตะฝะธั ะพ ะฝะตะพะฑัะพะดะธะผะพััะธ ะดะพะฑะฐะฒะปะตะฝะธั ะฒ ะณััะฟะฟั ะกะฃะ

**ะะฑะฝะพะฒะปะตะฝะพ ะฒ ะบะฐะถะดะพะน ะทะฐัะฒะบะต:**
```
Secondary Groups: monitoring_svc (ะธะปะธ CI10742292-lnx-mon_sys) โ ะะะะะ! ะััะฟะฟะฐ ะกะฃะ!

โ๏ธ ะะะะขะะงะะกะะ ะะะะะ: ะะฑัะทะฐัะตะปัะฝะพ ะดะพะฑะฐะฒะธัั ะฒ Secondary Groups ะณััะฟะฟั ะกะฃะ!
```

---

## ๐ ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

### ะกัะตะผะฐ ะดะปั ััะตะฝะดะฐ CI10742292

```
1. ะกะพะทะดะฐะฝะธะต ะกะฃะ ะฒ IDM:
   User: CI10742292-lnx-mon_sys
   Primary Group: CI10742292-lnx-mon_sys (ัะพะทะดะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ)

2. IDM ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐะตั ะณััะฟะฟั:
   Group: CI10742292-lnx-mon_sys

3. ะััะฐะปัะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะดะพะฑะฐะฒะปััััั ะฒ ััั ะณััะฟะฟั:
   CI10742292-lnx-mon_admin โ secondary group: CI10742292-lnx-mon_sys
   CI10742292-lnx-mon_ci    โ secondary group: CI10742292-lnx-mon_sys
   CI10742292-lnx-mon_ro    โ secondary group: CI10742292-lnx-mon_sys

4. Jenkins ะธะทะฒะปะตะบะฐะตั KAE_STEND ะธ ัะพัะผะธััะตั:
   monitoring_group: "CI10742292-lnx-mon_sys"

5. Ansible ะณะตะฝะตัะธััะตั systemd units:
   [Service]
   User=CI10742292-lnx-mon_sys
   Group=CI10742292-lnx-mon_sys

6. ะคะฐะนะปั ะฟะพะปััะฐัั ะฟัะฐะฒะฐ:
   Owner: CI10742292-lnx-mon_sys
   Group: CI10742292-lnx-mon_sys
   Perms: 770 (rwxrwx---)
```

---

## ๐ ะะตะทัะปััะฐัั

### Systemd units (ะฟะพัะปะต Ansible):

```ini
[Service]
User=CI10742292-lnx-mon_sys
Group=CI10742292-lnx-mon_sys  โ ะะธะฝะฐะผะธัะตัะบะฐั ะณััะฟะฟะฐ!
```

### ะัะฐะฒะฐ ะฝะฐ ัะฐะนะปั:

```bash
# ะะฐะฝะฝัะต
drwxrwx--- CI10742292-lnx-mon_sys CI10742292-lnx-mon_sys /opt/monitoring/data

# ะะพะณะธ
drwxrwx--- CI10742292-lnx-mon_sys CI10742292-lnx-mon_sys /opt/monitoring/logs

# ะะพะฝัะธะณััะฐัะธั
drwxr-x--- CI10742292-lnx-mon_ci CI10742292-lnx-mon_sys /opt/monitoring/config
```

### ะงะปะตะฝััะฒะพ ะฒ ะณััะฟะฟะต (ะฝะฐ ัะตัะฒะตัะต):

```bash
# ะกะฃะ
$ id CI10742292-lnx-mon_sys
uid=5001(CI10742292-lnx-mon_sys) gid=5001(CI10742292-lnx-mon_sys) groups=5001(CI10742292-lnx-mon_sys)

# ะะฃะ
$ id CI10742292-lnx-mon_admin
uid=5002(CI10742292-lnx-mon_admin) gid=5002(CI10742292-lnx-mon_admin) groups=5002(CI10742292-lnx-mon_admin),5001(CI10742292-lnx-mon_sys)
                                                                                                                   โ
                                                                                                    Secondary group ะกะฃะ โ

# ะขะฃะ
$ id CI10742292-lnx-mon_ci
uid=5003(CI10742292-lnx-mon_ci) gid=5003(CI10742292-lnx-mon_ci) groups=5003(CI10742292-lnx-mon_ci),5001(CI10742292-lnx-mon_sys)
                                                                                                              โ
                                                                                                   Secondary group ะกะฃะ โ

# ReadOnly
$ id CI10742292-lnx-mon_ro
uid=5004(CI10742292-lnx-mon_ro) gid=5004(CI10742292-lnx-mon_ro) groups=5004(CI10742292-lnx-mon_ro),5001(CI10742292-lnx-mon_sys)
                                                                                                            โ
                                                                                                 Secondary group ะกะฃะ โ
```

---

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะะทะพะปััะธั ะผะตะถะดั ััะตะฝะดะฐะผะธ

```
ะกัะตะฝะด CI10742292:
  Group: CI10742292-lnx-mon_sys
  Files: owned by CI10742292-lnx-mon_sys:CI10742292-lnx-mon_sys

ะกัะตะฝะด DEV123456:
  Group: DEV123456-lnx-mon_sys
  Files: owned by DEV123456-lnx-mon_sys:DEV123456-lnx-mon_sys

ะะตะทัะปััะฐั:
  โ ะะพะปะฝะฐั ะธะทะพะปััะธั
  โ ะะพะปัะทะพะฒะฐัะตะปะธ DEV123456 ะะ ะผะพะณัั ะฟะพะปััะธัั ะดะพัััะฟ ะบ ัะฐะนะปะฐะผ CI10742292
  โ ะะธะบะฐะบะธั ะฟะตัะตัะตัะตะฝะธะน ะฟะพ ะฟัะฐะฒะฐะผ
```

### ะะพะฝััะพะปั ะดะพัััะฟะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะกะปะพะน 1: IDM                                             โ
โ - ะะพะฝััะพะปะธััะตั ัะปะตะฝััะฒะพ ะฒ ะณััะฟะฟะฐั                      โ
โ - ะะพะบะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั ะฟะตัะตะทะฐะฟะธััะฒะฐัััั                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะกะปะพะน 2: File Permissions (770)                         โ
โ - ะะปะฐะดะตะปะตั: ะฟะพะปะฝัะน ะดะพัััะฟ                              โ
โ - ะััะฟะฟะฐ: ะฟะพะปะฝัะน ะดะพัััะฟ (ัะพะปัะบะพ ัะปะตะฝั ะณััะฟะฟั ะกะฃะ)      โ
โ - ะััะณะธะต: ะะะข ะดะพัััะฟะฐ                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะกะปะพะน 3: Sudoers                                         โ
โ - ะะณัะฐะฝะธัะธะฒะฐะตั ะดะตะนััะฒะธั ะบะฐะถะดะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั          โ
โ - ReadOnly: ัะพะปัะบะพ ััะตะฝะธะต (ะดะฐะถะต ะตัะปะธ ะฒ ะณััะฟะฟะต)         โ
โ - Admin: ัะฟัะฐะฒะปะตะฝะธะต, ะฝะพ ะฝะต ะดะตะฟะปะพะน                      โ
โ - CI: ะฟะพะปะฝัะต ะฟัะฐะฒะฐ ะดะปั ะดะตะฟะปะพั                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะะฝััััะบัะธั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

### ะัะธ ัะพะทะดะฐะฝะธะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฒ IDM:

#### 1. ะกะพะทะดะฐัั ะกะฃะ (ะะะะะซะ!)
```
ะะผั: CI10742292-lnx-mon_sys
ะขะธะฟ: NoLogin
Primary Group: CI10742292-lnx-mon_sys (auto)
```
**โ IDM ัะพะทะดะฐัั ะณััะฟะฟั ะฐะฒัะพะผะฐัะธัะตัะบะธ**

#### 2. ะกะพะทะดะฐัั ะะฃะ
```
ะะผั: CI10742292-lnx-mon_admin
ะขะธะฟ: Interactive
Primary Group: CI10742292-lnx-mon_admin (auto)
Secondary Groups: CI10742292-lnx-mon_sys โ ะะะะขะะงะะกะะ ะะะะะ!
```

#### 3. ะกะพะทะดะฐัั ะขะฃะ
```
ะะผั: CI10742292-lnx-mon_ci
ะขะธะฟ: Interactive
Primary Group: CI10742292-lnx-mon_ci (auto)
Secondary Groups: CI10742292-lnx-mon_sys โ ะะะะขะะงะะกะะ ะะะะะ!
```

#### 4. ะกะพะทะดะฐัั ReadOnly
```
ะะผั: CI10742292-lnx-mon_ro
ะขะธะฟ: Interactive
Primary Group: CI10742292-lnx-mon_ro (auto)
Secondary Groups: CI10742292-lnx-mon_sys โ ะะะะขะะงะะกะะ ะะะะะ!
```

### โ๏ธ ะงัะพ ะฟัะพะธะทะพะนะดะตั ะตัะปะธ ะะ ะดะพะฑะฐะฒะธัั ะฒ secondary group?

```bash
# ะะพะปัะทะพะฒะฐัะตะปั ะะ ะ ะะะฃะะะ:
$ su - CI10742292-lnx-mon_admin
$ ls /opt/monitoring/data/
ls: cannot access '/opt/monitoring/data/': Permission denied
โ ะะะข ะะะกะขะฃะะ!

# ะะพะปัะทะพะฒะฐัะตะปั ะ ะะะฃะะะ:
$ su - CI10742292-lnx-mon_admin
$ ls /opt/monitoring/data/
prometheus.db  wal/  chunks/
โ ะะะะะขะะะข!
```

---

## ๐ ะกัะฐัะธััะธะบะฐ ะธะทะผะตะฝะตะฝะธะน

| ะคะฐะนะป | ะกััะพะบ ะธะทะผะตะฝะตะฝะพ | ะะฟะธัะฐะฝะธะต |
|------|----------------|----------|
| `ansible/group_vars/monitoring.yml` | +4 | ะะธะฝะฐะผะธัะตัะบะฐั ะณััะฟะฟะฐ |
| `sudoers/monitoring_ci.template` | 13 ะทะฐะผะตะฝ | `:monitoring` โ `:{{USER_SYS}}` |
| `docs/DYNAMIC_GROUP_GUIDE.md` | +392 (ะฝะพะฒัะน) | ะะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ |
| `docs/IDM_ACCOUNTS_GUIDE.md` | +50 | ะกะตะบัะธั ะพ ะณััะฟะฟะต + ะธะฝััััะบัะธะธ |
| **ะะขะะะ** | **+459 ัััะพะบ** | |

---

## โ ะงะตะบะปะธัั ะฟัะพะฒะตัะบะธ

- [x] ะะฑะฝะพะฒะปะตะฝ `ansible/group_vars/monitoring.yml`
- [x] ะะฑะฝะพะฒะปะตะฝั sudoers templates
- [x] ะกะพะทะดะฐะฝะฐ ะดะพะบัะผะตะฝัะฐัะธั `DYNAMIC_GROUP_GUIDE.md`
- [x] ะะฑะฝะพะฒะปะตะฝะฐ ะดะพะบัะผะตะฝัะฐัะธั `IDM_ACCOUNTS_GUIDE.md`
- [x] ะะพะฑะฐะฒะปะตะฝั ะฟัะตะดัะฟัะตะถะดะตะฝะธั ะพ secondary groups
- [x] ะกะพะทะดะฐะฝ ะธัะพะณะพะฒัะน ะพััะตั

---

## ๐ฏ ะัะตะธะผััะตััะฒะฐ ัะตะฐะปะธะทะฐัะธะธ

โ **ะะฒัะพะผะฐัะธะทะฐัะธั** - ะณััะฟะฟะฐ ัะพะทะดะฐะตััั ะฟัะธ ัะพะทะดะฐะฝะธะธ ะกะฃะ ะฒ IDM  
โ **ะะทะพะปััะธั** - ะบะฐะถะดัะน ััะตะฝะด ะธะผะตะตั ัะฒะพั ัะฝะธะบะฐะปัะฝัั ะณััะฟะฟั  
โ **ะะตะทะพะฟะฐัะฝะพััั** - ะบะพะฝััะพะปั ัะตัะตะท IDM + file permissions + sudoers  
โ **ะัะพััะพัะฐ** - ะฝะต ะฝัะถะฝะพ ัะพะทะดะฐะฒะฐัั ะพัะดะตะปัะฝัั ะณััะฟะฟั  
โ **ะกัะฐะฝะดะฐัั** - ัะธะฟะธัะฝะฐั ะฟัะฐะบัะธะบะฐ Enterprise Linux  
โ **ะะฐัััะฐะฑะธััะตะผะพััั** - ะปะตะณะบะพ ัะฐะทะฒะตัะฝััั 10, 20, 100 ััะตะฝะดะพะฒ  

---

## ๐ ะกััะปะบะธ ะฝะฐ ะดะพะบัะผะตะฝัะฐัะธั

- `docs/DYNAMIC_GROUP_GUIDE.md` - ะฟะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ ะฟะพ ะดะธะฝะฐะผะธัะตัะบะพะน ะณััะฟะฟะต
- `docs/IDM_ACCOUNTS_GUIDE.md` - ัะพะทะดะฐะฝะธะต ะฃะ ั ะฟัะฐะฒะธะปัะฝัะผะธ ะณััะฟะฟะฐะผะธ
- `docs/KAE_STEND_NAMING.md` - ะดะธะฝะฐะผะธัะตัะบะธะต ะธะผะตะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- `ansible/group_vars/monitoring.yml` - ะบะพะฝัะธะณััะฐัะธั ะณััะฟะฟั

---

## ๐ ะัะพะณ

**ะะธะฝะฐะผะธัะตัะบะฐั ะณััะฟะฟะฐ (ะััะฟะฟะฐ = ะกะฃะ) ัะตะฐะปะธะทะพะฒะฐะฝะฐ!**

ะกะธััะตะผะฐ ัะตะฟะตัั ะธัะฟะพะปัะทัะตั **ัะฝะธะบะฐะปัะฝัั ะณััะฟะฟั ะดะปั ะบะฐะถะดะพะณะพ ััะตะฝะดะฐ**, ััะพ ะพะฑะตัะฟะตัะธะฒะฐะตั:
- โ ะะพะปะฝัั ะธะทะพะปััะธั ะผะตะถะดั ััะตะฝะดะฐะผะธ
- โ ะะฒัะพะผะฐัะธัะตัะบะพะต ัะพะทะดะฐะฝะธะต ัะตัะตะท IDM
- โ ะกะพะพัะฒะตัััะฒะธะต ะบะพัะฟะพัะฐัะธะฒะฝะพะน ะฟะพะปะธัะธะบะต
- โ ะฃะฟัะพัะตะฝะธะต ัะฟัะฐะฒะปะตะฝะธั

**ะกัะฐััั**: โ Production Ready  
**ะะฐัะฐ**: 19.11.2024  
**ะะตััะธั**: 2.2



