# Vault Agent Configuration Example
# Безопасная конфигурация Vault Agent для системы мониторинга
# Файл: /opt/monitoring/config/vault-agent.hcl

# =============================================================================
# PID FILE
# =============================================================================
pid_file = "/opt/monitoring/logs/vault-agent/vault-agent.pid"

# =============================================================================
# VAULT СЕРВЕР
# =============================================================================
vault {
  # Адрес Vault (SecMan)
  address = "https://vault.sigma.sbrf.ru"
  
  # Namespace (ИЗМЕНИТЬ на ваш namespace!)
  namespace = "KPRJ_000000"
  
  # Таймауты
  retry {
    num_retries = 5
  }
}

# =============================================================================
# AUTO AUTH - АВТОМАТИЧЕСКАЯ АУТЕНТИФИКАЦИЯ
# =============================================================================
auto_auth {
  # Метод аутентификации: AppRole
  method "approle" {
    # Конфигурация AppRole
    config = {
      # Путь к role_id (будет передан из Jenkins)
      role_id_file_path = "/opt/vault/conf/role_id.txt"
      
      # Путь к secret_id (будет передан из Jenkins)
      secret_id_file_path = "/opt/vault/conf/secret_id.txt"
      
      # Удалить secret_id после использования (безопасность)
      remove_secret_id_file_after_reading = false
      
      # Путь к AppRole в Vault
      # path = "auth/approle"
    }
  }
  
  # Sink - куда сохранять полученный токен
  sink "file" {
    config = {
      # Путь к токену (в tmpfs для безопасности)
      path = "/dev/shm/monitoring_secrets/vault-token"
      
      # Права на файл токена
      mode = 0600
    }
  }
}

# =============================================================================
# CACHE - КЭШИРОВАНИЕ ЗАПРОСОВ
# =============================================================================
cache {
  # Включить кэш
  use_auto_auth_token = true
}

# =============================================================================
# LISTENER - API ENDPOINT (опционально)
# =============================================================================
# Для использования Vault Agent как прокси для приложений
listener "tcp" {
  # Слушать на localhost (безопасность)
  address = "127.0.0.1:8200"
  
  # TLS отключен для localhost
  tls_disable = true
}

# =============================================================================
# TEMPLATES - АВТОМАТИЧЕСКАЯ ГЕНЕРАЦИЯ КОНФИГУРАЦИЙ
# =============================================================================

# -----------------------------------------------------------------------------
# Template 1: Сертификат сервера (server bundle)
# -----------------------------------------------------------------------------
template {
  # Источник: Vault path для генерации сертификата
  source = "/opt/monitoring/config/templates/server_cert.tpl"
  
  # Назначение: Полный bundle (cert + key)
  destination = "/dev/shm/monitoring_secrets/server_bundle.pem"
  
  # Права на файл
  perms = "0600"
  
  # Команда для перезапуска сервисов после обновления (опционально)
  # command = "systemctl --user restart prometheus grafana harvest"
  
  # Не перезапускать сразу, подождать обновления всех сертификатов
  command_timeout = "30s"
  
  # Политика ошибок
  error_on_missing_key = true
}

# -----------------------------------------------------------------------------
# Template 2: Разделение сертификата на cert и key
# -----------------------------------------------------------------------------
template {
  # Извлечение только certificate из bundle
  contents = <<EOT
{{ with secret "pki/issue/monitoring" "common_name=SERVER_DOMAIN" "alt_names=localhost" "ttl=2160h" }}
{{ .Data.certificate }}
{{ range .Data.ca_chain }}{{ . }}{{ end }}
{{ end }}
EOT
  
  destination = "/dev/shm/monitoring_secrets/server.crt"
  perms = "0640"
}

template {
  # Извлечение только private key из bundle
  contents = <<EOT
{{ with secret "pki/issue/monitoring" "common_name=SERVER_DOMAIN" "alt_names=localhost" "ttl=2160h" }}
{{ .Data.private_key }}
{{ end }}
EOT
  
  destination = "/dev/shm/monitoring_secrets/server.key"
  perms = "0600"
}

# -----------------------------------------------------------------------------
# Template 3: CA Chain
# -----------------------------------------------------------------------------
template {
  contents = <<EOT
{{ with secret "pki/issue/monitoring" "common_name=SERVER_DOMAIN" "ttl=2160h" }}
{{ range .Data.ca_chain }}{{ . }}{{ end }}
{{ end }}
EOT
  
  destination = "/dev/shm/monitoring_secrets/ca_chain.crt"
  perms = "0644"
}

# -----------------------------------------------------------------------------
# Template 4: Grafana client certificate (для mTLS с Prometheus)
# -----------------------------------------------------------------------------
template {
  contents = <<EOT
{{ with secret "pki/issue/monitoring-client" "common_name=grafana-client" "ttl=2160h" }}
{{ .Data.certificate }}
{{ end }}
EOT
  
  destination = "/dev/shm/monitoring_secrets/grafana-client.crt"
  perms = "0640"
}

template {
  contents = <<EOT
{{ with secret "pki/issue/monitoring-client" "common_name=grafana-client" "ttl=2160h" }}
{{ .Data.private_key }}
{{ end }}
EOT
  
  destination = "/dev/shm/monitoring_secrets/grafana-client.key"
  perms = "0600"
}

# -----------------------------------------------------------------------------
# Template 5: NetApp API credentials
# -----------------------------------------------------------------------------
template {
  contents = <<EOT
{{ with secret "secret/data/monitoring/netapp-api" }}
NETAPP_USER={{ .Data.data.user }}
NETAPP_PASS={{ .Data.data.pass }}
NETAPP_ADDR={{ .Data.data.addr }}
{{ end }}
EOT
  
  destination = "/dev/shm/monitoring_secrets/netapp_creds.env"
  perms = "0600"
  
  # Перезапустить Harvest после обновления credentials
  command = "systemctl --user restart harvest"
}

# -----------------------------------------------------------------------------
# Template 6: Grafana admin credentials
# -----------------------------------------------------------------------------
template {
  contents = <<EOT
{{ with secret "secret/data/monitoring/grafana-web" }}
GF_SECURITY_ADMIN_USER={{ .Data.data.user }}
GF_SECURITY_ADMIN_PASSWORD={{ .Data.data.pass }}
{{ end }}
EOT
  
  destination = "/dev/shm/monitoring_secrets/grafana_admin.env"
  perms = "0600"
}

# -----------------------------------------------------------------------------
# Template 7: Prometheus datasource для Grafana (JSON)
# -----------------------------------------------------------------------------
template {
  contents = <<EOT
{
  "name": "Prometheus",
  "type": "prometheus",
  "access": "proxy",
  "url": "https://SERVER_DOMAIN:9090",
  "basicAuth": false,
  "jsonData": {
    "tlsAuth": true,
    "tlsAuthWithCACert": true,
    "serverName": "SERVER_DOMAIN"
  },
  "secureJsonData": {
    {{ with secret "pki/issue/monitoring-client" "common_name=grafana-client" "ttl=2160h" }}
    "tlsClientCert": {{ .Data.certificate | toJSON }},
    "tlsClientKey": {{ .Data.private_key | toJSON }},
    "tlsCACert": {{ index .Data.ca_chain 0 | toJSON }}
    {{ end }}
  }
}
EOT
  
  destination = "/dev/shm/monitoring_secrets/prometheus_datasource.json"
  perms = "0640"
}

# -----------------------------------------------------------------------------
# Template 8: Harvest конфигурация с секретами
# -----------------------------------------------------------------------------
template {
  source = "/opt/monitoring/config/templates/harvest.yml.tpl"
  destination = "/opt/monitoring/config/harvest.yml"
  perms = "0640"
  
  # Перезапустить Harvest после обновления конфига
  command = "systemctl --user restart harvest"
  command_timeout = "30s"
}

# =============================================================================
# TELEMETRY - МЕТРИКИ VAULT AGENT
# =============================================================================
telemetry {
  # Отключить метрики (можно включить для отладки)
  disable_hostname = true
  
  # Prometheus метрики (опционально)
  # prometheus_retention_time = "30s"
}

# =============================================================================
# LOGGING - ЛОГИРОВАНИЕ
# =============================================================================
# По умолчанию логи идут в stderr (перехватываются systemd)
# log_level = "info"
# log_file = "/opt/monitoring/logs/vault-agent/agent.log"

# =============================================================================
# ПРИМЕЧАНИЯ ПО БЕЗОПАСНОСТИ
# =============================================================================
#
# 1. AppRole credentials:
#    - role_id и secret_id передаются из Jenkins
#    - Хранятся в /opt/vault/conf/ (не в /dev/shm, т.к. нужны постоянно)
#    - Права: 600, владелец monitoring_svc
#    - Не удаляются после чтения (для автоматического перезапуска)
#
# 2. Токены:
#    - Vault token сохраняется в /dev/shm (tmpfs)
#    - Автоматически обновляется при истечении
#    - Права: 600, только для monitoring_svc
#
# 3. Сертификаты:
#    - Все сертификаты генерируются через Vault PKI
#    - Сохраняются в /dev/shm (в RAM, не на диск)
#    - TTL: 90 дней (2160h)
#    - Автоматически обновляются за 30 дней до истечения
#
# 4. Секреты:
#    - NetApp credentials, Grafana credentials в /dev/shm
#    - Формат: environment файлы или JSON
#    - Права: 600/640
#    - Автоматическое обновление при изменении в Vault
#
# 5. Templates:
#    - Используют Consul Template синтаксис
#    - Автоматически перезапускают сервисы при обновлении
#    - Error handling включен (error_on_missing_key)
#
# 6. Listener:
#    - TCP listener на localhost:8200
#    - Позволяет приложениям использовать Vault Agent как прокси
#    - TLS отключен (localhost безопасен)
#
# 7. Namespace:
#    - ОБЯЗАТЕЛЬНО изменить на ваш namespace!
#    - Формат: KPRJ_XXXXXX
#    - Каждая команда АС имеет свой namespace
#
# 8. Мониторинг Vault Agent:
#    - Логи: journalctl --user -u vault-agent-monitoring
#    - PID: /opt/monitoring/logs/vault-agent/vault-agent.pid
#    - Статус: systemctl --user status vault-agent-monitoring
#
# 9. Troubleshooting:
#    - Проверить role_id и secret_id файлы
#    - Проверить права доступа к /dev/shm
#    - Проверить connectivity к Vault серверу
#    - Увеличить log_level до "debug"
#
# 10. Автоматическое обновление сертификатов:
#     - Vault Agent автоматически обновляет сертификаты за 1/3 TTL
#     - Для TTL=90d, обновление за ~30 дней
#     - После обновления перезапускаются сервисы (command)
#
# =============================================================================

# =============================================================================
# ПРИМЕР TEMPLATE ДЛЯ HARVEST (harvest.yml.tpl)
# =============================================================================
#
# Pollers:
#   Netapp-Cluster-01:
#     {{ with secret "secret/data/monitoring/netapp-api" }}
#     addr: {{ .Data.data.addr }}
#     username: {{ .Data.data.user }}
#     password: {{ .Data.data.pass }}
#     {{ end }}
#     auth_style: password
#     use_insecure_tls: false
#     collectors:
#       - Zapi
#       - ZapiPerf
#     exporters:
#       - prometheus1
#
# =============================================================================

# =============================================================================
# НАСТРОЙКА APPROLE В VAULT
# =============================================================================
#
# 1. Создать AppRole:
#    vault write auth/approle/role/monitoring-agent \
#      token_ttl=1h \
#      token_max_ttl=4h \
#      secret_id_ttl=24h \
#      token_policies="monitoring-agent-policy"
#
# 2. Получить role-id:
#    vault read auth/approle/role/monitoring-agent/role-id
#
# 3. Создать secret-id:
#    vault write -f auth/approle/role/monitoring-agent/secret-id
#
# 4. Создать policy (monitoring-agent-policy):
#    # Чтение KV секретов
#    path "secret/data/monitoring/*" {
#      capabilities = ["read", "list"]
#    }
#    
#    # Генерация сертификатов
#    path "pki/issue/monitoring" {
#      capabilities = ["create", "update"]
#    }
#    
#    path "pki/issue/monitoring-client" {
#      capabilities = ["create", "update"]
#    }
#
# =============================================================================






